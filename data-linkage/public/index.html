
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Orionデータプレビュー(編集:追加・削除)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Basic layout and typography */
    body { font-family: system-ui, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; margin: 24px; color: #222; }
    h1 { font-size: 28px; margin: 0 0 18px; font-weight: 700; }
    h2 { font-size: 18px; margin: 0 0 12px; font-weight: 600; }
    .section { margin: 20px 0; }
    label { display: inline-block; margin: 6px 0; font-weight: 600; }
    select, input[type="file"], button, input[type="text"] { padding: 6px; font-size: 14px; }
    .hint { font-size: 12px; color: #555; margin-top:6px; }
    .actions { margin-top: 12px; display: flex; gap: 8px; align-items:center; flex-wrap: wrap; }

    /* Table styles */
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    caption.hint { text-align: left; font-size: 12px; color: #666; padding-bottom: 6px; }
    th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; vertical-align: middle; font-size: 13px; }
    th { background: #f5f5f5; font-weight: 600; }

    /* Status and messages */
    #message { margin-top: 8px; font-size: 14px; color: #333; }
    .error-message { color: #d32f2f; font-weight: 600; }

    /* Add form */
    .add-form { padding: 10px; border: 1px dashed #aaa; margin-top: 10px; display: none; }
    .add-form label { font-weight: 500; }
    .add-form input, .add-form select { margin-right: 8px; }
    .left-actions { display: flex; gap: 8px; align-items: center; }
    .bottom-actions { margin-top: 16px; }

    /* Highlighting logic */
    td.cell-value-changed { background-color: #a0e3af; }
    td.cell-type-mismatch { background-color: #fab3b9; }

    /* File picker visual tweaks */
    .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0 0 0 0); white-space: nowrap; border: 0; }
    .file-label { display: inline-block; padding: 6px 12px; font-size: 14px; background: #fff; color: #000; border-radius: 6px; cursor: pointer; border: 1px solid black; }
    .file-status { font-size: 13px; color: #444; }
    .file-row { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }

    /* Mode toggles (visibility) */
    #previewTable.orion-only thead th.csv-col,
    #previewTable.orion-only tbody td.csv-col { display: none; }
    #previewTable.orion-csv thead th.ops-col,
    #previewTable.orion-csv tbody td.ops-col { display: none; }
    .hide-in-csv { display: none; }

    /* Register button styling */
    .register-container { display: flex; justify-content: center; align-items: center; }
    .register-btn { font-size: 18px; padding: 10px 24px; border-radius: 6px; background: #254e9b; color: #fff; border: none; cursor: pointer; }
    .register-btn.hidden { display: none; }
    .register-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Add button placement */
    .add-button-container { margin-top: 16px; text-align: left; }
    .add-button-container.hidden { display: none; }

    /* Error dialogs (reusable) */
    .error-dialog { position: relative; background: #fab3b9; border: 2px solid #ab4850; border-radius: 6px; padding: 16px 40px 16px 16px; margin-bottom: 16px; display: none; }
    .error-dialog.visible { display: block; }
    .error-dialog-title { font-weight: 600; color: black; margin-bottom: 8px; font-size: 14px; }
    .error-dialog-content { color: black; font-size: 13px; line-height: 1.5; }
    .error-dialog-close { position: absolute; top: 8px; right: 8px; background: none; border: none; font-size: 20px; color: #ab4850; cursor: pointer; padding: 4px 8px; line-height: 1; }
    .error-dialog-close:hover { color: #8b3b42; }

    /* Responsive adjustments */
    @media (max-width: 640px) {
      th, td { padding: 6px 8px; font-size: 12px; }
      .actions { flex-direction: column; align-items: stretch; }
      .left-actions { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <h1>データ連携基盤　データプレビュー</h1>

  <!-- FIWARE context selection -->
  <div class="section" aria-labelledby="fiware-context">
    <h2 id="fiware-context">FIWAREコンテキスト選択</h2>
    <div class="left-actions">
      <div>
        <label for="fiwareService">Fiware-Service</label><br />
        <select id="fiwareService" name="fiwareService" required>
          <option value="">選択してください</option>
          <option value="sekisho" selected>sekisho</option>
        </select>
      </div>
      <button type="button" id="btnFetch">データ再取得</button>
    </div>
    <div class="hint">削除・追加は固定エンティティ(ID/Type)に対して実行されます。</div>
  </div>

  <!-- CSV upload section -->
  <div class="section" aria-labelledby="csv-select">
    <h2 id="csv-select">CSVファイル選択</h2>
    <div class="file-row">
      <input type="file" id="csv_file" name="csv_file" accept=".csv" class="visually-hidden" />
      <label for="csv_file" class="file-label" aria-label="ファイルを選択">ファイルを選択</label>
      <span id="fileStatus" class="file-status" aria-live="polite">ファイルが選択されていません</span>
      <button type="button" id="btnPreviewCsv">読み込む</button>
      <button type="button" id="btnClearCsv">クリア</button>
    </div>
    <div class="hint">※Excel「画面イメージ」に沿ったヘッダを推奨: <code>項目名,設定する値</code></div>
  </div>

  <!-- Preview section -->
  <div class="section" aria-labelledby="preview">
    <h2 id="preview">プレビュー</h2>

    <!-- Type mismatch error dialog (counted) -->
    <div id="errorDialog" class="error-dialog">
      <button class="error-dialog-close" onclick="document.getElementById('errorDialog').classList.remove('visible')" aria-label="閉じる">×</button>
      <div id="errorDialogTitle" class="error-dialog-title">データ型の不一致が検出されました。以下の項目にエラーがあります（0件）：</div>
      <div class="error-dialog-content" id="errorDialogContent"></div>
    </div>

    <!-- Mapping missing error dialog (counted) -->
    <div id="mappingErrorDialog" class="error-dialog">
      <button class="error-dialog-close" onclick="document.getElementById('mappingErrorDialog').classList.remove('visible')" aria-label="閉じる">×</button>
      <div id="mappingErrorDialogTitle" class="error-dialog-title">データ連携基盤未設定の項目が検出されました（0件）：</div>
      <div class="error-dialog-content" id="mappingErrorDialogContent"></div>
    </div>

    <!-- CSV validation error dialog (counted) -->
    <div id="csvErrorDialog" class="error-dialog">
      <button class="error-dialog-close" onclick="document.getElementById('csvErrorDialog').classList.remove('visible')" aria-label="閉じる">×</button>
      <div id="csvErrorDialogTitle" class="error-dialog-title">CSVエラー（0件）：</div>
      <div class="error-dialog-content" id="csvErrorDialogContent"></div>
    </div>

    <!-- Main preview table -->
    <table id="previewTable" class="orion-only" aria-describedby="preview-desc">
      <caption id="preview-desc" class="hint">
        列構成(データ連携基盤): 項目名 / システム項目名（内部キー）/ 保存データ（型） / 保存データ（値） / 操作(削除)<br />
        列構成(データ連携基盤–CSV): 項目名 / システム項目名（内部キー） / 保存データ（型） / 保存データ（値） / 取込データ（型） / 取込データ（値）
      </caption>
      <thead>
        <tr>
          <th>項目名</th>
          <th>システム項目名</th>
          <th>保存データ（型）</th>
          <th>保存データ（値）</th>
          <th class="csv-col">取込データ（型）</th>
          <th class="csv-col">取込データ（値）</th>
          <th class="ops-col">操作</th>
        </tr>
      </thead>
      <tbody id="previewBody"></tbody>
    </table>

    <!-- Add button (visible only in Orion-only mode) -->
    <div id="addButtonContainer" class="add-button-container">
      <button type="button" id="btnAdd">追加</button>
    </div>

    <!-- Register button (visible in Orion–CSV mode) -->
    <div class="bottom-actions register-container">
      <button type="button" id="btnRegister" class="register-btn hidden">登録</button>
    </div>

    <!-- Inline Add Form -->
    <div id="addForm" class="add-form" role="region" aria-label="属性追加フォーム">
      <div style="margin-bottom:8px;"><strong>新規属性の追加</strong></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <label>項目名</label>
        <input type="text" id="addJpName" placeholder="例:つくば市_人口時点" />
        <label>システム項目名（内部キー）</label>
        <input type="text" id="addKey" placeholder="例:tsukubaCityPopulationDate" />
        <label>データ（型）</label>
        <select id="addType">
          <option value="Text">Text</option>
          <option value="Integer">Integer</option>
          <option value="Float">Float</option>
          <option value="DateTime">DateTime</option>
        </select>
        <label>データ（値）</label>
        <input type="text" id="addValue" placeholder="値(型に合わせて入力)" />
        <button type="button" id="btnAddConfirm">確認</button>
        <button type="button" id="btnAddCancel">キャンセル</button>
      </div>
      <div class="hint">システム項目名は英数字とアンダースコアのみ。DateTimeはISO8601(例:2025-10-01T00:00:00Z)。</div>
    </div>
  </div>

  <div id="message" class="section" aria-live="polite"></div>

<script>
/* Endpoint constants */
const API_FETCH_ORION = '/app/api.php?action=fetch_orion';
const API_GET_MAPPING = '/app/api.php?action=get_mapping';
const API_DELETE_ATTR = '/app/api.php?action=orion_delete_attr';
const API_ADD_ATTR    = '/app/api.php?action=orion_add_attr';
const API_PUSH_JSON   = '/app/api.php?action=push_json';
const API_UPLOAD_CSV  = '/app/api.php?action=upload_csv';
const PUSH_TARGET_URL = 'http://localhost:8080/api.php';

/* DOM references */
const fiwareSelect = document.getElementById('fiwareService');
const btnFetch     = document.getElementById('btnFetch');
const btnAdd       = document.getElementById('btnAdd');
const addButtonContainer = document.getElementById('addButtonContainer');
const addForm   = document.getElementById('addForm');
const addJpName = document.getElementById('addJpName');
const addKey    = document.getElementById('addKey');
const addType   = document.getElementById('addType');
const addValue  = document.getElementById('addValue');
const btnAddConfirm = document.getElementById('btnAddConfirm');
const btnAddCancel  = document.getElementById('btnAddCancel');

const csvFileInput  = document.getElementById('csv_file');
const btnPreviewCsv = document.getElementById('btnPreviewCsv');
const btnClearCsv   = document.getElementById('btnClearCsv');
const fileStatus    = document.getElementById('fileStatus');

const previewTable = document.getElementById('previewTable');
const previewBody  = document.getElementById('previewBody');
const btnRegister  = document.getElementById('btnRegister');

const messageBox   = document.getElementById('message');

const errorDialog        = document.getElementById('errorDialog');
const errorDialogTitle   = document.getElementById('errorDialogTitle');
const errorDialogContent = document.getElementById('errorDialogContent');

const mappingErrorDialog        = document.getElementById('mappingErrorDialog');
const mappingErrorDialogTitle   = document.getElementById('mappingErrorDialogTitle');
const mappingErrorDialogContent = document.getElementById('mappingErrorDialogContent');

const csvErrorDialog        = document.getElementById('csvErrorDialog');
const csvErrorDialogTitle   = document.getElementById('csvErrorDialogTitle');
const csvErrorDialogContent = document.getElementById('csvErrorDialogContent');

/* State variables */
let orionDataFormatB = null;
let csvDataFormatB   = null;

let engToJpMapping   = {};
let mappingLoaded    = false;

let hasTypeMismatch   = false;
let hasBlockingErrors = false;

/* Utility to update register button availability */
function updateRegisterState() {
  btnRegister.disabled = hasTypeMismatch || hasBlockingErrors;
}

/* Build reverse mapping: key(lowercase) -> jpName */
async function loadMappingReverse() {
  try {
    const res = await fetch(API_GET_MAPPING, { method: 'GET' });
    if (!res.ok) throw new Error(`Mapping fetch error (${res.status})`);
    const json = await res.json();
    if (json.status !== 'success' || !json.map) throw new Error(json.message || 'Invalid mapping response');
    const reverse = {};
    Object.entries(json.map).forEach(([jp, info]) => {
      if (info && info.key) reverse[String(info.key).toLowerCase()] = jp;
    });
    engToJpMapping = reverse;
    mappingLoaded = true;
  } catch (e) {
    console.error(e);
    mappingLoaded = false;
  }
}

/* Fetch Orion preview and backend flags */
async function fetchOrionForService(service) {
  const url = `${API_FETCH_ORION}&service=${encodeURIComponent(service)}`;
  const res = await fetch(url, { method: 'GET' });
  if (!res.ok) throw new Error(`Orion fetch error (${res.status})`);
  const json = await res.json();
  if (json.status === 'error') throw new Error(json.message || 'Orion API error');
  return json; // {status, preview, blocking, can_push}
}

/* Flatten Format-B to row list for table rendering */
function flattenFormatB(entities) {
  const rows = [];
  if (!Array.isArray(entities)) return rows;
  entities.forEach(entity => {
    const attributes = entity?.attributes ?? {};
    Object.keys(attributes).forEach(attrKey => {
      const attr   = attributes[attrKey] ?? {};
      const jpName = engToJpMapping[String(attrKey).toLowerCase()] ?? attrKey;
      rows.push({
        jp_name: jpName,
        key:     attrKey,
        type:    attr.type ?? 'Text',
        value:   attr.value !== undefined ? attr.value : ''
      });
    });
  });
  return rows;
}

/* Build a simple key(lower) -> row map for lookup */
function buildLookup(rows) {
  const map = {};
  rows?.forEach(r => { map[String(r.key).toLowerCase()] = r; });
  return map;
}

/* Missing checks */
function isMissing(v) {
  const s = String(v ?? '').trim();
  return s === '' || s === '—' || s === '-' || s === '–';
}

/* Compare cells and decide highlight type */
function rowChangeStatus(orionType, orionValue, csvType, csvValue) {
  const tO = String(orionType ?? '').trim();
  const vO = String(orionValue ?? '').trim();
  const tC = String(csvType  ?? '').trim();
  const vC = String(csvValue ?? '').trim();
  if (isMissing(tO) || isMissing(tC) || isMissing(vO) || isMissing(vC)) return 'none';
  if (tO !== tC) return 'type';
  if (vO !== vC) return 'value';
  return 'none';
}

/* Render Orion-only mode */
function renderOrionOnly(rows) {
  previewTable.classList.remove('orion-csv');
  previewTable.classList.add('orion-only');
  btnRegister.classList.add('hidden');
  addButtonContainer.classList.remove('hidden');
  messageBox.className = 'section';
  hasTypeMismatch = false;
  previewBody.innerHTML = '';

  if (!Array.isArray(rows) || rows.length === 0) {
    messageBox.textContent = '表示するデータがありません。';
    updateRegisterState();
    return;
  }

  rows.forEach(item => {
    const tr    = document.createElement('tr');
    const tdJp  = document.createElement('td'); tdJp.textContent  = item.jp_name ?? '(未指定)';
    const tdKey = document.createElement('td'); tdKey.textContent = item.key ?? '';
    const tdOty = document.createElement('td'); tdOty.textContent = item.type ?? '';
    const tdOval= document.createElement('td'); tdOval.textContent= item.value ?? '';
    const tdCty = document.createElement('td'); tdCty.className = 'csv-col'; tdCty.textContent = '—';
    const tdCval= document.createElement('td'); tdCval.className= 'csv-col'; tdCval.textContent = '—';
    const tdOps = document.createElement('td'); tdOps.className = 'ops-col';
    const btnDel= document.createElement('button'); btnDel.textContent = '削除';
    btnDel.addEventListener('click', () => onDeleteClicked(item.key, item.jp_name));
    tdOps.appendChild(btnDel);
    tr.append(tdJp, tdKey, tdOty, tdOval, tdCty, tdCval, tdOps);
    previewBody.appendChild(tr);
  });

  messageBox.textContent = `データ取得完了: ${rows.length}件を表示。`;
  updateRegisterState();
}

/* Render Orion–CSV comparison mode with type mismatch highlighting */
function renderOrionCsv(orionRows, csvRows) {
  previewTable.classList.remove('orion-only');
  previewTable.classList.add('orion-csv');
  btnRegister.classList.remove('hidden');
  addButtonContainer.classList.add('hidden');
  messageBox.className = 'section';

  hasTypeMismatch = false;
  const mismatchedItems = [];
  previewBody.innerHTML = '';

  const o = buildLookup(orionRows);
  const c = buildLookup(csvRows);
  const keys = new Set([...Object.keys(o), ...Object.keys(c)]);

  if (keys.size === 0) {
    messageBox.textContent = '表示するデータがありません。';
    errorDialog.classList.remove('visible');
    updateRegisterState();
    return;
  }

  keys.forEach(k => {
    const oItem = o[k];
    const cItem = c[k];
    const jp = (oItem?.jp_name ?? cItem?.jp_name) ?? '(未指定)';
    const key = (oItem?.key ?? cItem?.key) ?? '';
    const orionType  = oItem?.type  ?? '—';
    const orionValue = oItem?.value ?? '—';
    const csvType    = cItem?.type  ?? '—';
    const csvValue   = cItem?.value ?? '—';

    const tr   = document.createElement('tr');
    const tdJp = document.createElement('td'); tdJp.textContent = jp;
    const tdKey= document.createElement('td'); tdKey.textContent = key;
    const tdOty= document.createElement('td'); tdOty.textContent = orionType;
    const tdOval=document.createElement('td'); tdOval.textContent= orionValue;

    const tdCty = document.createElement('td'); tdCty.className = 'csv-col'; tdCty.textContent = csvType;
    const tdCval= document.createElement('td'); tdCval.className= 'csv-col'; tdCval.textContent = csvValue;

    const tdOps = document.createElement('td'); tdOps.className = 'ops-col';
    const btnDel= document.createElement('button'); btnDel.textContent = '削除';
    btnDel.addEventListener('click', () => onDeleteClicked(key, jp));
    tdOps.appendChild(btnDel);

    const status = rowChangeStatus(orionType, orionValue, csvType, csvValue);
    if (status === 'type') {
      tdCty.classList.add('cell-type-mismatch');
      tdCval.classList.add('cell-type-mismatch');
      hasTypeMismatch = true;
      mismatchedItems.push(jp);
    } else if (status === 'value') {
      tdCty.classList.add('cell-value-changed');
      tdCval.classList.add('cell-value-changed');
    }

    tr.append(tdJp, tdKey, tdOty, tdOval, tdCty, tdCval, tdOps);
    previewBody.appendChild(tr);
  });

  // Type mismatch dialog with count in specified format
  const mismatchCount = mismatchedItems.length;
  if (mismatchCount > 0) {
    if (errorDialogTitle) {
      errorDialogTitle.textContent = `データ型の不一致が検出されました。以下の項目にエラーがあります（${mismatchCount}件）：`;
    }
    errorDialogContent.innerHTML = mismatchedItems.map(item => `${item}`).join('<br>');
    errorDialog.classList.add('visible');
  } else {
    errorDialog.classList.remove('visible');
  }

  messageBox.textContent = `比較表示: データ連携基盤 ${orionRows?.length ?? 0}件 / CSV ${csvRows?.length ?? 0}件`;
  updateRegisterState();
}

/* Delete attribute from Orion and update mapping */
async function onDeleteClicked(attrKey, jpName) {
  if (!attrKey) return;
  const confirmMessage = `以下の項目がシステムから削除されます。\n「${jpName}」を削除してもよろしいですか？`;
  if (!confirm(confirmMessage)) return;

  try {
    const body = new URLSearchParams();
    body.append('attrKey', attrKey);
    const res = await fetch(API_DELETE_ATTR, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: body.toString()
    });
    const json = await res.json();
    if (json.status !== 'success') throw new Error(json.message || '削除に失敗しました');
    messageBox.className = 'section';
    messageBox.textContent = `削除成功: key=${attrKey}`;
    hasBlockingErrors = !!json.blocking;
    updateRegisterState();
    await refreshPreview();
  } catch (e) {
    console.error(e);
    messageBox.className = 'section error-message';
    messageBox.textContent = `削除失敗: ${e.message}`;
    hasBlockingErrors = true;
    updateRegisterState();
  }
}

/* Add form visibility control */
function showAddForm() {
  addForm.style.display = 'block';
  addJpName.value = '';
  addKey.value    = '';
  addType.value   = 'Text';
  addValue.value  = '';
  addForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
function hideAddForm() { addForm.style.display = 'none'; }

/* Add attribute to Orion */
async function onAddConfirm() {
  const jpName   = addJpName.value.trim();
  const attrKey  = addKey.value.trim();
  const attrType = addType.value;
  const attrValue= addValue.value.trim();

  if (jpName === '') { alert('項目名を入力してください。'); return; }
  if (!/^[A-Za-z][A-Za-z0-9_]*$/.test(attrKey)) { alert('システム項目名は英数字とアンダースコア、先頭は英字です。'); return; }
  if (attrType === 'Integer' && !/^-?\d+$/.test(attrValue)) { alert('整数値を入力してください。'); return; }
  if (attrType === 'Float'   && !/^-?\d+\.\d+$/.test(attrValue)) { alert('小数(例:12.34)を入力してください。'); return; }
  if (attrType === 'DateTime' && !/^\d{4}\-\d{2}\-\d{2}T\d{2}:\d{2}(?::\d{2}(?:\.\d+)?)?(Z|[+\-]\d{2}:\d{2})$/.test(attrValue)) {
    alert('DateTimeはISO8601で入力してください(例:2025-10-01T00:00:00Z)。'); return;
  }

  const confirmMessage = `以下の項目がシステムに追加されます。\n「${jpName}」を追加してもよろしいですか？`;
  if (!confirm(confirmMessage)) return;

  try {
    const body = new URLSearchParams();
    body.append('jpName', jpName);
    body.append('attrKey', attrKey);
    body.append('attrType', attrType);
    body.append('attrValue', attrValue);
    const res = await fetch(API_ADD_ATTR, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: body.toString()
    });
    const json = await res.json();
    if (json.status !== 'success') {
      alert(json.message || '追加に失敗しました');
      messageBox.className = 'section error-message';
      messageBox.textContent = `追加失敗: ${json.message || '不明なエラー'}`;
      hasBlockingErrors = true;
      updateRegisterState();
      return;
    }
    messageBox.className = 'section';
    messageBox.textContent = `追加成功: ${jpName} / ${attrKey} / ${attrType}`;
    hideAddForm();
    hasBlockingErrors = !!json.blocking;
    updateRegisterState();
    await refreshPreview();
  } catch (e) {
    console.error(e);
    messageBox.className = 'section error-message';
    messageBox.textContent = `追加失敗: ${e.message}`;
    hasBlockingErrors = true;
    updateRegisterState();
  }
}

/* Push JSON to external app (server enforces blocking and type mismatch) */
async function pushJsonToServer(targetUrl) {
  const body = new URLSearchParams();
  body.append('url', targetUrl);
  const res = await fetch(API_PUSH_JSON, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: body.toString()
  });
  return res.json();
}

btnRegister.addEventListener('click', async () => {
  if (hasTypeMismatch || hasBlockingErrors) {
    alert('エラーが解消されるまで「登録」はできません。詳細はエラーダイアログをご確認ください。');
    return;
  }
  messageBox.className = 'section';
  messageBox.textContent = '外部サイトへ送信中...';
  try {
    const res = await pushJsonToServer(PUSH_TARGET_URL);
    if (res.status === 'success') {
      messageBox.textContent = `送信成功: HTTP ${res.http_code}. ソース: ${res.source}`;
    } else {
      const code = res.error_code ? ` (${res.error_code})` : '';
      messageBox.className = 'section error-message';
      messageBox.textContent = `送信失敗: ${res.message || res.error || JSON.stringify(res)}${code}`;
      hasBlockingErrors = true;
      updateRegisterState();
    }
  } catch (e) {
    messageBox.className = 'section error-message';
    messageBox.textContent = '送信中にエラーが発生しました。コンソールを確認してください。';
    console.error(e);
    hasBlockingErrors = true;
    updateRegisterState();
  }
});

/* Refresh preview depending on current mode and backend flags */
async function refreshPreview() {
  const svc = fiwareSelect.value;
  if (!svc) {
    messageBox.className = 'section error-message';
    messageBox.textContent = 'Fiware-Serviceを選択してください。';
    hasBlockingErrors = true;
    updateRegisterState();
    return;
  }
  try {
    messageBox.className = 'section';
    messageBox.textContent = 'データを取得しています...';
    await loadMappingReverse();

    const result = await fetchOrionForService(svc);
    orionDataFormatB = result.preview || [];
    const oRows = flattenFormatB(orionDataFormatB);

    if (csvDataFormatB && Array.isArray(csvDataFormatB) && csvDataFormatB.length > 0) {
      const cRows = flattenFormatB(csvDataFormatB);
      renderOrionCsv(oRows, cRows);
    } else {
      renderOrionOnly(oRows);
    }

    hasBlockingErrors = !!result.blocking;
    updateRegisterState();

    messageBox.className = 'section';
    if (csvDataFormatB && Array.isArray(csvDataFormatB) && csvDataFormatB.length > 0) {
      messageBox.textContent = 'CSVの比較表示を更新しました。';
    } else {
      messageBox.textContent = 'データ連携基盤の表示を更新しました。';
    }
  } catch (err) {
    console.error(err);
    messageBox.className = 'section error-message';
    messageBox.textContent = '取得に失敗しました。コンソールを確認してください。';
    hasBlockingErrors = true;
    updateRegisterState();
  }
}

/* CSV controls: selection and upload */
csvFileInput.addEventListener('change', () => {
  const f = csvFileInput.files && csvFileInput.files[0];
  fileStatus.textContent = f ? f.name : 'ファイルが選択されていません';
});

btnPreviewCsv.addEventListener('click', async () => {
  const f = csvFileInput.files && csvFileInput.files[0];
  if (!f) { alert('CSVファイルを選択してください。'); return; }
  fileStatus.textContent = f.name;
  messageBox.className = 'section';
  messageBox.textContent = 'CSVをサーバへ送信しています...';

  try {
    const fd = new FormData();
    fd.append('csv_file', f);
    const res = await fetch(API_UPLOAD_CSV, { method: 'POST', body: fd });
    if (!res.ok) throw new Error('Upload Failed');
    const json = await res.json();

    if (json.status === 'error') {
      const errors  = Array.isArray(json.errors) ? json.errors : [];
      const preview = Array.isArray(json.preview) ? json.preview : [];

      // Show preview even on error (duplicates allowed)
      if (preview.length > 0) {
        csvDataFormatB = preview;
        await refreshPreview();
      }

      // CSV error dialog with count
      const count = errors.length;
      csvErrorDialogTitle.textContent   = `CSVエラー（${count}件）：`;
      csvErrorDialogContent.innerHTML   = errors.map(e => `${e}`).join('<br>');
      csvErrorDialog.classList.add('visible');

      messageBox.className = 'section error-message';
      messageBox.textContent = 'CSVの検証でエラーが発生しました。';
      hasBlockingErrors = json.blocking === true || json.can_push === false;
      updateRegisterState();
      return;
    }

    // Success: store preview and show mapping-missing dialog with count
    csvDataFormatB = json.preview || [];
    const skipped = json.skipped_jp_names || [];
    if (Array.isArray(skipped) && skipped.length > 0) {
      const skippedCount = skipped.length;
      mappingErrorDialogTitle.textContent = `データ連携基盤未設定の項目が検出されました（${skippedCount}件）：`;
      mappingErrorDialogContent.innerHTML = skipped.map(s => `${s}`).join('<br>');
      mappingErrorDialog.classList.add('visible');
    } else {
      mappingErrorDialog.classList.remove('visible');
    }
    hasBlockingErrors = !!json.blocking;
    updateRegisterState();
    await refreshPreview();
  } catch (err) {
    console.error(err);
    messageBox.className = 'section error-message';
    messageBox.textContent = 'CSVアップロード/変換に失敗しました: ' + (err.message || err);
    hasBlockingErrors = true;
    updateRegisterState();
  }
});

/* Clear CSV: hide add button and disable register until next success */
btnClearCsv.addEventListener('click', () => {
  csvDataFormatB = null;
  csvFileInput.value = '';
  fileStatus.textContent = 'ファイルが選択されていません';
  previewBody.innerHTML = '';
  btnRegister.classList.add('hidden');
  addButtonContainer.classList.add('hidden'); /* Spec: hide "追加" after clear */
  previewTable.classList.add('orion-only');
  previewTable.classList.remove('orion-csv');

  // Close all dialogs
  errorDialog.classList.remove('visible');
  mappingErrorDialog.classList.remove('visible');
  csvErrorDialog.classList.remove('visible');

  messageBox.className = 'section';
  messageBox.textContent = 'CSVプレビューをクリアしました。';
  hasTypeMismatch   = false;
  hasBlockingErrors = true;
  updateRegisterState();
});

/* Wire buttons */
fiwareSelect.addEventListener('change', refreshPreview);
btnFetch.addEventListener('click', refreshPreview);
btnAdd.addEventListener('click', showAddForm);
btnAddConfirm.addEventListener('click', onAddConfirm);
btnAddCancel.addEventListener('click', hideAddForm);

/* Initialize with default service 'sekisho' */
(async () => {
  fiwareSelect.value = fiwareSelect.value || 'sekisho';
  await refreshPreview();
})();
</script>
</body>
